#!/usr/bin/env bash
# dotbins-verify - Verify dotbins installation and health check
# This script checks that dotbins is properly set up and all tools are functional

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
DOTBINS_DIR="${DOTBINS_DIR:-$HOME/.dotbins}"

# Counters for summary
CHECKS_PASSED=0
CHECKS_FAILED=0
WARNINGS=0

# Print colored output
print_success() {
    echo -e "${GREEN}✓${NC} $1"
    ((CHECKS_PASSED++))
}

print_error() {
    echo -e "${RED}✗${NC} $1"
    ((CHECKS_FAILED++))
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARNINGS++))
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_header() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}\n"
}

# Check if dotbins directory exists
check_dotbins_dir() {
    print_header "Checking dotbins directory"
    
    if [[ -d "$DOTBINS_DIR" ]]; then
        print_success "dotbins directory exists: $DOTBINS_DIR"
    else
        print_error "dotbins directory not found: $DOTBINS_DIR"
        print_info "Run: git clone https://github.com/cbwinslow/.dotbins ~/.dotbins"
        return 1
    fi
    
    # Check if it's a git repository
    if [[ -d "$DOTBINS_DIR/.git" ]]; then
        print_success "dotbins is a git repository"
    else
        print_error "dotbins directory is not a git repository"
        return 1
    fi
}

# Detect current platform
detect_platform() {
    print_header "Detecting platform"
    
    local os arch
    os=$(uname -s | tr '[:upper:]' '[:lower:]')
    [[ "$os" == "darwin" ]] && os="macos"
    
    arch=$(uname -m)
    [[ "$arch" == "x86_64" ]] && arch="amd64"
    [[ "$arch" == "aarch64" || "$arch" == "arm64" ]] && arch="arm64"
    
    PLATFORM="$os/$arch"
    BIN_DIR="$DOTBINS_DIR/$os/$arch/bin"
    
    print_success "Detected platform: $PLATFORM"
    print_info "Binary directory: $BIN_DIR"
}

# Check if binary directory exists
check_bin_dir() {
    print_header "Checking binary directory"
    
    if [[ -d "$BIN_DIR" ]]; then
        print_success "Binary directory exists: $BIN_DIR"
        
        # Count binaries
        local bin_count
        bin_count=$(find "$BIN_DIR" -type f -executable 2>/dev/null | wc -l)
        print_info "Found $bin_count binary files"
    else
        print_error "Binary directory not found: $BIN_DIR"
        print_info "Run: dotbins sync --current"
        return 1
    fi
}

# Check if dotbins is in PATH
check_path() {
    print_header "Checking PATH configuration"
    
    if echo "$PATH" | grep -q "$BIN_DIR"; then
        print_success "dotbins binary directory is in PATH"
    else
        print_error "dotbins binary directory NOT in PATH"
        print_info "Add to your shell config:"
        print_info "  bash: source ~/.dotbins/shell/bash.sh"
        print_info "  zsh:  source ~/.dotbins/shell/zsh.sh"
        return 1
    fi
}

# Check Git LFS
check_git_lfs() {
    print_header "Checking Git LFS"
    
    if command -v git-lfs >/dev/null 2>&1; then
        print_success "git-lfs is installed"
        
        # Check if LFS is initialized
        cd "$DOTBINS_DIR" || return 1
        if git lfs env >/dev/null 2>&1; then
            print_success "Git LFS is initialized"
        else
            print_warning "Git LFS not initialized"
            print_info "Run: git lfs install"
        fi
    else
        print_warning "git-lfs not found (required for binary downloads)"
        print_info "Install: sudo apt-get install git-lfs (Linux)"
        print_info "         brew install git-lfs (macOS)"
    fi
}

# Check if binaries are actual files or LFS pointers
check_lfs_pointers() {
    print_header "Checking for LFS pointer files"
    
    local pointer_count=0
    local binary_count=0
    
    if [[ -d "$BIN_DIR" ]]; then
        while IFS= read -r -d '' file; do
            if file "$file" | grep -q "ASCII text"; then
                # Might be an LFS pointer
                if head -1 "$file" | grep -q "version https://git-lfs.github.com"; then
                    ((pointer_count++))
                fi
            else
                ((binary_count++))
            fi
        done < <(find "$BIN_DIR" -type f -print0)
        
        if [[ $pointer_count -eq 0 ]]; then
            print_success "All files are binaries (no LFS pointers)"
        else
            print_error "Found $pointer_count LFS pointer files (not downloaded)"
            print_info "Run: cd ~/.dotbins && git lfs pull"
        fi
        
        print_info "Binary files: $binary_count"
    fi
}

# Test tools functionality
check_tools() {
    print_header "Testing tool functionality"
    
    local tools=(
        "fzf:--version"
        "bat:--version"
        "rg:--version"
        "fd:--version"
        "eza:--version"
        "zoxide:--version"
        "starship:--version"
        "lazygit:--version"
        "delta:--version"
        "duf:--version"
        "dust:--version"
        "direnv:--version"
        "hyperfine:--version"
        "atuin:--version"
        "git-lfs:--version"
        "micromamba:--version"
        "uv:--version"
        "yazi:--version"
    )
    
    for tool_spec in "${tools[@]}"; do
        local tool="${tool_spec%%:*}"
        local flag="${tool_spec#*:}"
        
        if command -v "$tool" >/dev/null 2>&1; then
            # Test if it actually runs
            if timeout 2s "$tool" "$flag" >/dev/null 2>&1; then
                print_success "$tool is working"
            else
                print_warning "$tool found but failed to run"
            fi
        else
            print_info "$tool not found (optional)"
        fi
    done
}

# Check manifest.json
check_manifest() {
    print_header "Checking manifest.json"
    
    local manifest="$DOTBINS_DIR/manifest.json"
    
    if [[ -f "$manifest" ]]; then
        print_success "manifest.json exists"
        
        # Validate JSON
        if command -v jq >/dev/null 2>&1; then
            if jq empty "$manifest" 2>/dev/null; then
                print_success "manifest.json is valid JSON"
                
                # Count entries
                local count
                count=$(jq 'keys | length' "$manifest" 2>/dev/null)
                print_info "Manifest contains $count entries"
            else
                print_error "manifest.json is invalid JSON"
            fi
        else
            print_info "jq not found, skipping JSON validation"
        fi
    else
        print_warning "manifest.json not found"
    fi
}

# Check dotbins.yaml
check_config() {
    print_header "Checking dotbins.yaml"
    
    local config="$DOTBINS_DIR/dotbins.yaml"
    
    if [[ -f "$config" ]]; then
        print_success "dotbins.yaml exists"
        
        # Count tools
        local tool_count
        tool_count=$(grep -c "^  [a-z]" "$config" 2>/dev/null || echo "0")
        print_info "Configuration contains ~$tool_count tools"
    else
        print_error "dotbins.yaml not found"
    fi
}

# Check for dotbins Python tool
check_dotbins_tool() {
    print_header "Checking dotbins CLI tool"
    
    if command -v dotbins >/dev/null 2>&1; then
        print_success "dotbins CLI tool is installed"
        
        # Get version
        if dotbins --version >/dev/null 2>&1; then
            local version
            version=$(dotbins --version 2>&1 | head -1)
            print_info "Version: $version"
        fi
    else
        print_warning "dotbins CLI tool not found"
        print_info "Install: pip install dotbins"
        print_info "         or: pipx install dotbins"
    fi
}

# Check Git remote
check_git_remote() {
    print_header "Checking Git remote"
    
    cd "$DOTBINS_DIR" || return 1
    
    if git remote -v | grep -q "origin"; then
        local remote_url
        remote_url=$(git remote get-url origin)
        print_success "Git remote configured: $remote_url"
        
        # Check if we can reach it
        if git ls-remote --exit-code origin >/dev/null 2>&1; then
            print_success "Can connect to remote repository"
        else
            print_warning "Cannot connect to remote repository"
            print_info "Check your network connection"
        fi
    else
        print_warning "No Git remote configured"
    fi
}

# Print summary
print_summary() {
    print_header "Summary"
    
    echo -e "${GREEN}Passed:${NC}  $CHECKS_PASSED"
    echo -e "${RED}Failed:${NC}  $CHECKS_FAILED"
    echo -e "${YELLOW}Warnings:${NC} $WARNINGS"
    
    echo ""
    
    if [[ $CHECKS_FAILED -eq 0 ]]; then
        echo -e "${GREEN}✓ dotbins is properly configured!${NC}"
        exit 0
    elif [[ $CHECKS_FAILED -le 2 ]]; then
        echo -e "${YELLOW}⚠ dotbins is partially configured (minor issues)${NC}"
        exit 0
    else
        echo -e "${RED}✗ dotbins has configuration issues${NC}"
        echo "See errors above for details"
        exit 1
    fi
}

# Main execution
main() {
    echo "dotbins Verification Tool"
    echo "========================="
    
    detect_platform
    check_dotbins_dir || true
    check_bin_dir || true
    check_path || true
    check_git_lfs || true
    check_lfs_pointers || true
    check_manifest || true
    check_config || true
    check_dotbins_tool || true
    check_git_remote || true
    check_tools || true
    
    print_summary
}

# Run main function
main "$@"
