#!/usr/bin/env bash
# dotbins-info - Get information about installed and available tools
# This script provides detailed information about tools in the dotbins repository

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Configuration
DOTBINS_DIR="${DOTBINS_DIR:-$HOME/.dotbins}"
MANIFEST="$DOTBINS_DIR/manifest.json"
CONFIG="$DOTBINS_DIR/dotbins.yaml"

# Tool descriptions (can be expanded or loaded from external file)
declare -A TOOL_DESCRIPTIONS=(
    ["atuin"]="Magical shell history with sync capabilities"
    ["bat"]="Cat clone with syntax highlighting and Git integration"
    ["delta"]="Syntax-highlighting pager for git, diff, and grep output"
    ["direnv"]="Load/unload environment variables based on directory"
    ["duf"]="Disk Usage/Free utility - a better 'df' alternative"
    ["dust"]="More intuitive version of du (disk usage)"
    ["eza"]="Modern replacement for 'ls' with colors and icons"
    ["fd"]="Simple, fast alternative to 'find'"
    ["fzf"]="Command-line fuzzy finder"
    ["git-lfs"]="Git extension for versioning large files"
    ["hyperfine"]="Command-line benchmarking tool"
    ["lazygit"]="Simple terminal UI for git commands"
    ["micromamba"]="Fast, small conda package manager"
    ["rg"]="ripgrep - recursively search directories for regex pattern"
    ["starship"]="Minimal, fast, customizable prompt for any shell"
    ["uv"]="Ultra-fast Python package installer and resolver"
    ["uvx"]="Python application runner (part of uv)"
    ["yazi"]="Blazing fast terminal file manager"
    ["zoxide"]="Smarter cd command, inspired by z and autojump"
)

# Tool categories
declare -A TOOL_CATEGORIES=(
    ["atuin"]="Shell Enhancement"
    ["bat"]="File Viewer"
    ["delta"]="Git Tool"
    ["direnv"]="Development Tool"
    ["duf"]="System Utility"
    ["dust"]="System Utility"
    ["eza"]="File Manager"
    ["fd"]="Search Tool"
    ["fzf"]="Search Tool"
    ["git-lfs"]="Git Tool"
    ["hyperfine"]="Benchmarking"
    ["lazygit"]="Git Tool"
    ["micromamba"]="Package Manager"
    ["rg"]="Search Tool"
    ["starship"]="Shell Enhancement"
    ["uv"]="Package Manager"
    ["uvx"]="Package Manager"
    ["yazi"]="File Manager"
    ["zoxide"]="Shell Enhancement"
)

# Print colored output
print_header() {
    echo -e "\n${BOLD}${BLUE}$1${NC}"
    echo -e "${BLUE}$(printf '═%.0s' {1..50})${NC}\n"
}

print_tool_name() {
    echo -e "${BOLD}${CYAN}$1${NC}"
}

print_field() {
    echo -e "  ${BOLD}$1:${NC} $2"
}

print_list_item() {
    echo -e "  ${GREEN}•${NC} $1"
}

# Get platform
get_platform() {
    local os arch
    os=$(uname -s | tr '[:upper:]' '[:lower:]')
    [[ "$os" == "darwin" ]] && os="macos"
    
    arch=$(uname -m)
    [[ "$arch" == "x86_64" ]] && arch="amd64"
    [[ "$arch" == "aarch64" || "$arch" == "arm64" ]] && arch="arm64"
    
    echo "$os/$arch"
}

# Check if tool is installed
is_tool_installed() {
    local tool="$1"
    command -v "$tool" >/dev/null 2>&1
}

# Get tool version from manifest
get_tool_version() {
    local tool="$1"
    local platform="$2"
    
    if [[ ! -f "$MANIFEST" ]] || ! command -v jq >/dev/null 2>&1; then
        echo "unknown"
        return
    fi
    
    local key="${tool}/${platform}"
    local version
    version=$(jq -r ".[\"$key\"].tag // \"unknown\"" "$MANIFEST" 2>/dev/null)
    echo "$version"
}

# Get tool URL from manifest
get_tool_url() {
    local tool="$1"
    local platform="$2"
    
    if [[ ! -f "$MANIFEST" ]] || ! command -v jq >/dev/null 2>&1; then
        echo "unknown"
        return
    fi
    
    local key="${tool}/${platform}"
    local url
    url=$(jq -r ".[\"$key\"].url // \"unknown\"" "$MANIFEST" 2>/dev/null)
    echo "$url"
}

# Get tool repository from config
get_tool_repo() {
    local tool="$1"
    
    if [[ ! -f "$CONFIG" ]]; then
        echo "unknown"
        return
    fi
    
    # Try to extract repo from YAML (simple grep approach)
    local repo
    repo=$(grep -A 1 "^  $tool:" "$CONFIG" | grep "repo:" | sed 's/.*repo: //' | tr -d '"' 2>/dev/null)
    
    if [[ -z "$repo" ]]; then
        # Try simple format: tool: user/repo
        repo=$(grep "^  $tool:" "$CONFIG" | sed "s/^  $tool: //" | tr -d '"' 2>/dev/null)
    fi
    
    echo "${repo:-unknown}"
}

# Get installed version
get_installed_version() {
    local tool="$1"
    
    if ! is_tool_installed "$tool"; then
        echo "not installed"
        return
    fi
    
    # Try common version flags
    local version
    for flag in --version -v version; do
        version=$("$tool" "$flag" 2>&1 | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1 2>/dev/null || true)
        if [[ -n "$version" ]]; then
            echo "$version"
            return
        fi
    done
    
    echo "unknown"
}

# Show info for a specific tool
show_tool_info() {
    local tool="$1"
    local platform
    platform=$(get_platform)
    
    print_tool_name "$tool"
    
    # Description
    if [[ -n "${TOOL_DESCRIPTIONS[$tool]:-}" ]]; then
        print_field "Description" "${TOOL_DESCRIPTIONS[$tool]}"
    fi
    
    # Category
    if [[ -n "${TOOL_CATEGORIES[$tool]:-}" ]]; then
        print_field "Category" "${TOOL_CATEGORIES[$tool]}"
    fi
    
    # Repository
    local repo
    repo=$(get_tool_repo "$tool")
    if [[ "$repo" != "unknown" ]]; then
        print_field "Repository" "https://github.com/$repo"
    fi
    
    # Installation status
    if is_tool_installed "$tool"; then
        local installed_version
        installed_version=$(get_installed_version "$tool")
        print_field "Status" "${GREEN}Installed${NC} (version: $installed_version)"
        print_field "Location" "$(command -v "$tool")"
    else
        print_field "Status" "${YELLOW}Not installed${NC}"
    fi
    
    # Version in manifest
    local manifest_version
    manifest_version=$(get_tool_version "$tool" "$platform")
    if [[ "$manifest_version" != "unknown" ]]; then
        print_field "Available Version" "$manifest_version"
    fi
    
    # Download URL
    local url
    url=$(get_tool_url "$tool" "$platform")
    if [[ "$url" != "unknown" && "$url" != "null" ]]; then
        print_field "Download URL" "$url"
    fi
    
    echo ""
}

# List all tools
list_all_tools() {
    print_header "Available Tools"
    
    if [[ ! -f "$CONFIG" ]]; then
        echo "Error: dotbins.yaml not found at $CONFIG"
        exit 1
    fi
    
    # Extract tool names from YAML
    local tools
    mapfile -t tools < <(grep "^  [a-z]" "$CONFIG" | sed 's/:.*//' | sed 's/^  //' | sort -u)
    
    local platform
    platform=$(get_platform)
    
    for tool in "${tools[@]}"; do
        local status_icon
        if is_tool_installed "$tool"; then
            status_icon="${GREEN}✓${NC}"
        else
            status_icon="${YELLOW}○${NC}"
        fi
        
        local description="${TOOL_DESCRIPTIONS[$tool]:-No description}"
        local version
        version=$(get_tool_version "$tool" "$platform")
        
        printf "%b %-15s %s" "$status_icon" "$tool" "$description"
        if [[ "$version" != "unknown" ]]; then
            printf " ${CYAN}(v%s)${NC}" "$version"
        fi
        echo ""
    done
    
    echo ""
    echo -e "${GREEN}✓${NC} = Installed    ${YELLOW}○${NC} = Not installed"
}

# Search tools by keyword
search_tools() {
    local keyword="$1"
    local found=0
    
    print_header "Search results for: $keyword"
    
    # Search in tool names
    for tool in "${!TOOL_DESCRIPTIONS[@]}"; do
        if [[ "$tool" =~ $keyword ]] || [[ "${TOOL_DESCRIPTIONS[$tool]}" =~ $keyword ]]; then
            show_tool_info "$tool"
            ((found++))
        fi
    done
    
    if [[ $found -eq 0 ]]; then
        echo "No tools found matching: $keyword"
    else
        echo -e "\nFound $found tool(s)"
    fi
}

# Show tools by category
show_category() {
    local category="$1"
    local found=0
    
    print_header "Tools in category: $category"
    
    for tool in "${!TOOL_CATEGORIES[@]}"; do
        if [[ "${TOOL_CATEGORIES[$tool]}" == "$category" ]]; then
            local status_icon
            if is_tool_installed "$tool"; then
                status_icon="${GREEN}✓${NC}"
            else
                status_icon="${YELLOW}○${NC}"
            fi
            
            printf "%b %-15s %s\n" "$status_icon" "$tool" "${TOOL_DESCRIPTIONS[$tool]:-}"
            ((found++))
        fi
    done
    
    if [[ $found -eq 0 ]]; then
        echo "No tools found in category: $category"
    fi
}

# List categories
list_categories() {
    print_header "Tool Categories"
    
    # Get unique categories
    local categories=()
    for cat in "${TOOL_CATEGORIES[@]}"; do
        if [[ ! " ${categories[*]} " =~ " ${cat} " ]]; then
            categories+=("$cat")
        fi
    done
    
    # Sort and display
    IFS=$'\n' sorted_categories=($(sort <<<"${categories[*]}"))
    unset IFS
    
    for cat in "${sorted_categories[@]}"; do
        # Count tools in category
        local count=0
        for tool in "${!TOOL_CATEGORIES[@]}"; do
            [[ "${TOOL_CATEGORIES[$tool]}" == "$cat" ]] && ((count++))
        done
        
        printf "%b %-20s (%d tools)\n" "${CYAN}•${NC}" "$cat" "$count"
    done
}

# Show usage
show_usage() {
    cat <<EOF
Usage: dotbins-info [COMMAND] [OPTIONS]

Get information about dotbins tools

Commands:
    list                List all available tools
    info TOOL           Show detailed information about a tool
    search KEYWORD      Search for tools by keyword
    category [NAME]     List categories or show tools in a category
    installed           List only installed tools
    missing             List tools not yet installed

Examples:
    dotbins-info list
    dotbins-info info fzf
    dotbins-info search "git"
    dotbins-info category "Git Tool"
    dotbins-info installed

EOF
}

# Show installed tools only
show_installed() {
    print_header "Installed Tools"
    
    local count=0
    for tool in "${!TOOL_DESCRIPTIONS[@]}"; do
        if is_tool_installed "$tool"; then
            local version
            version=$(get_installed_version "$tool")
            printf "${GREEN}✓${NC} %-15s %s ${CYAN}(v%s)${NC}\n" "$tool" "${TOOL_DESCRIPTIONS[$tool]}" "$version"
            ((count++))
        fi
    done | sort
    
    echo -e "\nTotal installed: $count"
}

# Show missing tools
show_missing() {
    print_header "Not Installed Tools"
    
    local count=0
    for tool in "${!TOOL_DESCRIPTIONS[@]}"; do
        if ! is_tool_installed "$tool"; then
            printf "${YELLOW}○${NC} %-15s %s\n" "$tool" "${TOOL_DESCRIPTIONS[$tool]}"
            ((count++))
        fi
    done | sort
    
    echo -e "\nTotal not installed: $count"
    echo -e "\nTo install all tools: ${BOLD}dotbins sync${NC}"
    echo -e "To install specific tool: ${BOLD}dotbins sync TOOLNAME${NC}"
}

# Main function
main() {
    local command="${1:-list}"
    
    case "$command" in
        list)
            list_all_tools
            ;;
        info)
            if [[ $# -lt 2 ]]; then
                echo "Error: Please specify a tool name"
                echo "Usage: dotbins-info info TOOLNAME"
                exit 1
            fi
            show_tool_info "$2"
            ;;
        search)
            if [[ $# -lt 2 ]]; then
                echo "Error: Please specify a search keyword"
                echo "Usage: dotbins-info search KEYWORD"
                exit 1
            fi
            search_tools "$2"
            ;;
        category)
            if [[ $# -lt 2 ]]; then
                list_categories
            else
                show_category "$2"
            fi
            ;;
        installed)
            show_installed
            ;;
        missing)
            show_missing
            ;;
        help|--help|-h)
            show_usage
            ;;
        *)
            echo "Error: Unknown command: $command"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
